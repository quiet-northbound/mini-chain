M2 + M3 Spec (1 trang) — Build-a-Mini-Layer2 (Theo Source of Truth)
1) Mục tiêu (M2, M3)

M2: Hoàn thiện mini Layer1: data model rõ ràng + luồng tx end-to-end + validate/apply + lưu chain history ổn định.

M3: Bổ sung block & ledger semantics tối thiểu: gom tx vào block, tính block hash đơn giản, đảm bảo replay protection theo nonce + history nhất quán.

2) Data model tối thiểu
2.1 Account

address: string (ID account)

balance: long (số dư coin gốc, integer)

nonce: long (số tx đã gửi thành công)

(optional) pubKey: string (nếu muốn mock signature “đúng người”)

Invariants

balance >= 0

nonce >= 0

Nonce chỉ tăng khi tx được apply thành công.

2.2 Tx (Transaction)

from: string

to: string

amount: long

nonce: long (nonce mà sender “muốn dùng”)

chainId: string (để chống replay cross-chain, tối thiểu là constant)

signature: string (mock)

TxId (deterministic)

txId = hash(from|to|amount|nonce|chainId)

Dùng để detect duplicate/replay trong cùng chain history.

2.3 Ledger/State

accounts: Map<address, Account>

txHistory: List<TxReceipt> hoặc Map<txId, TxReceipt>

latestBlockHeight: long

latestBlockHash: string

TxReceipt

txId: string

status: Success|Failed

error: string?

blockHeight: long? (nếu đã commit vào block)

appliedAt: datetime

2.4 Block

height: long

prevHash: string

timestamp: datetime

txIds: List<string> (hoặc list Tx)

stateRoot: string (mock: hash của snapshot/state summary)

blockHash: string = hash(height|prevHash|timestamp|txIds|stateRoot)

Note: stateRoot mock có thể là hash(sorted(address,balance,nonce)) hoặc hash(latestBlockHeight|latestBlockHash|...).

3) Flow xử lý (Source of Truth)
3.1 Create Tx

User tạo payload:

chọn from, to, amount

lấy expectedNonce = state.accounts[from].nonce

set tx.nonce = expectedNonce

set chainId

3.2 Sign (mock)

signature = mockSign(tx, fromSecret)

Quy ước mock đơn giản (ví dụ): signature == "SIG:" + hash(txId + fromSecret)

Mục tiêu: có đúng/sai rõ ràng để test.

3.3 Validate

Validate theo thứ tự (fail fast):

Account tồn tại: from phải có trong state (hoặc auto-create với balance=0, nonce=0 nhưng phải thống nhất)

Amount hợp lệ: amount > 0

Balance đủ: accounts[from].balance >= amount

Nonce đúng: tx.nonce == accounts[from].nonce

Signature hợp lệ (mock): verifyMockSig(tx)

Replay check:

txId chưa tồn tại trong txHistory

(tuỳ chọn) nonce của sender chưa từng được dùng cho một tx success (thực tế nonce check đã cover)

3.4 Apply

Nếu validate pass:

accounts[from].balance -= amount

accounts[to].balance += amount (nếu to chưa tồn tại: create mới balance=0, nonce=0 rồi cộng)

accounts[from].nonce += 1

3.5 Append history

Ghi TxReceipt(status=Success, txId, appliedAt, blockHeight=? )

Nếu fail validate: cũng append receipt Failed (để trace), nhưng không update state.

3.6 Block commit (M3)

Mỗi N tx (hoặc mỗi lần gọi commitBlock()):

tạo Block(height=latest+1, prevHash=latestBlockHash, txIds=[success txIds since last block], stateRoot=calcMockRoot())

update latestBlockHeight/latestBlockHash

gán blockHeight vào receipts tương ứng

append block vào chainHistory: List<Block>

4) Error codes tối thiểu (gợi ý để test)

ERR_INSUFFICIENT_BALANCE

ERR_INVALID_NONCE

ERR_INVALID_SIGNATURE

ERR_REPLAY_TX

ERR_CHAIN_HISTORY_MISMATCH (khi block.prevHash != latestBlockHash hoặc height không liên tục)

5) 5 Test scenarios (bắt buộc)
(1) Happy path

Setup: A=100, B=0, A.nonce=0

Tx: A→B amount=10 nonce=0, signature đúng

Expect:

A.balance=90, B.balance=10

A.nonce=1

receipt Success, txId có trong history

(nếu commit block) blockHeight tăng, prevHash đúng

(2) Nonce sai

Setup: A.nonce=1

Tx: nonce=0 (hoặc 2)

Expect:

validate fail ERR_INVALID_NONCE

balances/nonce không đổi

receipt Failed được append

(3) Thiếu balance

Setup: A.balance=5

Tx: amount=10

Expect:

fail ERR_INSUFFICIENT_BALANCE

state không đổi

receipt Failed

(4) Chữ ký mock sai

Setup: tạo tx hợp lệ nhưng signature bị đổi

Expect:

fail ERR_INVALID_SIGNATURE

state không đổi

receipt Failed

(5) Replay tx + Chain history

Gộp 2 kiểm tra nền tảng (ưu tiên replay; chain history là phần block):

Replay: gửi lại y hệt tx đã success (same txId)

Expect: fail ERR_REPLAY_TX (hoặc fail nonce nếu nonce đã tăng — nhưng test replay nên giữ txId check để trả đúng lỗi)

Chain history: cố commit một block với prevHash sai hoặc height nhảy cóc

Expect: reject ERR_CHAIN_HISTORY_MISMATCH, không update latestBlockHash/height