# M0 + M1 Spec — Ledger Foundation + Mini Chain

> **Status**: ✅ Implemented — `src/MiniChain/MiniChain.Core/`

---

## 1) Mục tiêu

| Milestone | Mô tả |
|-----------|--------|
| **M0** | Ledger + accounts + signed transaction (mock signature) |
| **M1** | Apply tx + validate nonce/balance + transaction history |

---

## 2) Data Model

### 2.1 Account

| Field | Type | Mô tả |
|-------|------|--------|
| `Address` | string | Định danh duy nhất, lowercase |
| `Balance` | ulong | Số dư coin gốc, luôn ≥ 0 |
| `Nonce` | ulong | Số tx gửi thành công, chỉ tăng khi tx apply thành công |

**Invariants:**
- `Balance >= 0`
- `Nonce >= 0`
- Nonce chỉ tăng khi tx được apply thành công

### 2.2 Transaction

| Field | Type | Mô tả |
|-------|------|--------|
| `From` | string | Địa chỉ người gửi (lowercase) |
| `To` | string | Địa chỉ người nhận (lowercase) |
| `Amount` | ulong | Số tiền chuyển, phải > 0 |
| `Nonce` | ulong | Nonce kỳ vọng của sender |
| `ChainId` | string | Định danh chain (chống replay cross-chain) |
| `Signature` | string | Chữ ký mock |
| `TxId` | string | `SHA-256(canonical JSON payload)` — deterministic |
| `Type` | string | Luôn = `"transfer"` (v0) |

**TxId derivation:**
```
TxId = SHA-256({"amount":10,"chainId":"mini-chain-v1","from":"alice","nonce":0,"to":"bob"})
```
> Keys sorted alphabetically — đảm bảo deterministic.

### 2.3 TxReceipt

| Field | Type | Mô tả |
|-------|------|--------|
| `TxId` | string | ID giao dịch |
| `Status` | enum | `Success` hoặc `Failed` |
| `FailureReason` | ValidationError? | Lý do thất bại (null nếu success) |
| `AppliedAt` | DateTime | Thời điểm xử lý |
| `BlockHeight` | ulong? | Sẽ dùng ở M2/M3 |

### 2.4 Ledger (State)

| Field | Type | Mô tả |
|-------|------|--------|
| `Accounts` | `Map<address, Account>` | Bản đồ tài khoản |
| `SeenTxIds` | `Set<string>` | TxId đã xử lý thành công (anti-replay) |
| `TxHistory` | `List<TxReceipt>` | Lịch sử biên nhận (cả success + failed) |
| `ChainId` | string | `"mini-chain-v1"` |

---

## 3) Processing Flow

### 3.1 Create Tx
- User chọn `from`, `to`, `amount`
- Lấy `expectedNonce = accounts[from].nonce`
- Set `chainId`
- TxId = `SHA-256(canonical JSON payload)`

### 3.2 Sign (mock)
```
signature = "SIG(" + from + "|" + to + "|" + amount + "|" + nonce + "|" + chainId + ")"
```
> Mục tiêu: có đúng/sai rõ ràng để test — không phải crypto thật.

### 3.3 Validate (fail-fast)

Kiểm tra theo thứ tự — **dừng ngay khi gặp lỗi đầu tiên**:

| # | Check | Error Code |
|---|-------|------------|
| 1 | ChainId đúng | `INVALID_CHAIN_ID` |
| 2 | Signature hợp lệ (mock) | `INVALID_SIGNATURE` |
| 3 | TxId chưa tồn tại trong `seenTxIds` | `REPLAY_TX` |
| 4 | Amount > 0 | `INVALID_AMOUNT` |
| 5 | from ≠ to | `SELF_TRANSFER` |
| 6 | Sender account tồn tại | `ACCOUNT_NOT_FOUND` |
| 7 | `tx.nonce == accounts[from].nonce` | `INVALID_NONCE` |
| 8 | `accounts[from].balance >= amount` | `INSUFFICIENT_BALANCE` |

### 3.4 Apply
Nếu validate pass:
```
accounts[from].balance -= amount
accounts[to].balance += amount     ← auto-create nếu chưa tồn tại
accounts[from].nonce += 1
```

### 3.5 Record Receipt
- **Success**: thêm txId vào `seenTxIds`, tạo `TxReceipt(Success)`
- **Failed**: tạo `TxReceipt(Failed, reason)` — state KHÔNG đổi, txId KHÔNG thêm vào `seenTxIds`

### 3.6 State Root
```
StateRoot = SHA-256({"balances":{"alice":90,"bob":10},"nonces":{"alice":1}})
```
> Canonical JSON sorted state — dùng để so sánh state giữa các node.

---

## 4) Decisions (Đã quyết định)

| # | Quyết định | Lựa chọn |
|---|-----------|----------|
| D-1 | Failure handling | **skip-invalid** — ghi receipt Failed, tiếp tục tx tiếp |
| D-2 | State root | `SHA-256(canonical_json(sorted_state))` |
| D-3 | Serialization | Canonical JSON (sorted keys, compact, no nulls) |
| D-4 | Address format | Lowercase string (e.g. "alice", "bob") |
| D-5 | Mock signature | `SIG(from\|to\|amount\|nonce\|chainId)` |

---

## 5) Test Scenarios (5 bắt buộc)

### (1) Happy path — chuyển tiền hợp lệ
- **Setup**: A=100, B=0, A.nonce=0
- **Tx**: A→B, amount=10, nonce=0, signature đúng
- **Expect**: A.balance=90, B.balance=10, A.nonce=1, receipt Success

### (2) Nonce sai
- **Setup**: A.nonce=1
- **Tx**: nonce=0
- **Expect**: fail `INVALID_NONCE`, state không đổi, receipt Failed

### (3) Thiếu balance
- **Setup**: A.balance=5
- **Tx**: amount=10
- **Expect**: fail `INSUFFICIENT_BALANCE`, state không đổi

### (4) Chữ ký sai
- **Setup**: tx hợp lệ nhưng signature bị sửa
- **Expect**: fail `INVALID_SIGNATURE`, state không đổi

### (5) Replay tx
- **Setup**: đã apply tx1 thành công (txId=X)
- **Tx**: gửi lại y hệt tx1 (cùng txId)
- **Expect**: fail `REPLAY_TX`, state không đổi

---

## 6) Invariants (Bất biến)

- ✅ Nonce chỉ tăng khi tx thành công
- ✅ Tổng balance toàn hệ (chỉ transfer) không đổi
- ✅ Mỗi txId chỉ được apply tối đa 1 lần
- ✅ State root deterministic: cùng operations → cùng hash

---

## 7) Source Files

| File | Vai trò |
|------|---------|
| [Account.cs](../../src/MiniChain/MiniChain.Core/Models/Account.cs) | Data model tài khoản |
| [Transaction.cs](../../src/MiniChain/MiniChain.Core/Models/Transaction.cs) | Data model giao dịch + TxId |
| [TxReceipt.cs](../../src/MiniChain/MiniChain.Core/Models/TxReceipt.cs) | Biên nhận kết quả |
| [Hasher.cs](../../src/MiniChain/MiniChain.Core/Crypto/Hasher.cs) | SHA-256 hash |
| [MockSigner.cs](../../src/MiniChain/MiniChain.Core/Crypto/MockSigner.cs) | Chữ ký giả lập |
| [CanonicalJson.cs](../../src/MiniChain/MiniChain.Core/Serialization/CanonicalJson.cs) | Serialize tất định |
| [TxValidator.cs](../../src/MiniChain/MiniChain.Core/Validation/TxValidator.cs) | Kiểm tra hợp lệ (8 bước) |
| [Ledger.cs](../../src/MiniChain/MiniChain.Core/State/Ledger.cs) | Sổ cái + submit flow |
| [LedgerTests.cs](../../src/MiniChain/MiniChain.Tests/LedgerTests.cs) | 8 test cases |